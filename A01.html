<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>图片画廊（修复 PhotoSwipe 白屏问题）</title>

  <!-- PhotoSwipe CSS（官方） -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe.css" />

  <!-- Slick CSS（仅引入，如你需要 slider 可启用） -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick-theme.min.css" />

  <style>
/* ====== 布局结构：左侧导航 + 主内容（保持你原样） ====== */
.split-layout {
  display: flex;
  flex-direction: row;
  width: 100%;
  min-height: 100vh;
}
.split-layout .left-panel { width: 26%; background-color: #f9f9f9; padding: 2rem; box-sizing: border-box; }
.split-layout .right-panel { flex: 1; padding: 5.8rem 4.5rem; box-sizing: border-box; }
@media screen and (max-width: 1024px) {
  .split-layout { flex-direction: column; }
  .split-layout .left-panel { width: 100%; height: auto; padding: 2rem 2.5rem; }
  .split-layout .right-panel { padding: 3.5rem 2rem; }
}
.content_padding { padding-top: 5.8rem; padding-left: 4.5rem; padding-right: 4.5rem; padding-bottom: 4rem; }
.page_content { margin: 0 auto; max-width: 1200px; }

/* ====== 图片画廊样式（保持原样，不改间距） ====== */
.image-gallery {
  position: relative;
  display: flex;
  flex-wrap: wrap;
  margin-left: -2rem;
  margin-right: -2rem;
}
.image-gallery [image-gallery-pad] {
  padding-left: 0.7rem;
  padding-right: 0.7rem;
  box-sizing: border-box;
}
.gallery_card { margin-bottom: 1.3rem; }
.gallery_card_image { position: relative; width: 100%; overflow: hidden; }
.gallery_card_image img { width: 100%; height: auto; display: block; object-fit: cover; transition: opacity 0.6s ease, transform 0.6s ease; }

/* 滚动动画保持原样 */
.scroll-transition-fade { transition: transform 1s ease-in-out, opacity 0.8s ease-in-out; }
.scroll-transition-fade.below-viewport { opacity: 0; transform: translateY(40px); }

/* 移动端间距（保持原样） */
@media (max-width: 768px) {
  .image-gallery [image-gallery-pad] { padding: 1.25rem; }
}

/* 光标：提示可放大（仅提示） */
.image-zoom { cursor: zoom-in; }

/* PhotoSwipe 特殊样式（不会影响你的布局） */
.pswp { z-index: 100000 !important; --pswp-bg-opacity: 0.95; }
.pswp__bg { background-color: rgba(20,20,20,0.95); }
.pswp__button { opacity: 0.95; transition: opacity .2s ease; }
.pswp__button:hover { opacity: 1; }
  </style>
</head>
<body>
  <div class="split-layout split-responsive">
    <div class="left-panel"></div>

    <div class="right-panel">
      <bodycopy class="bodycopy content content_padding">
        <div class="page_content clearfix" data-elementresizer data-resize-parent data-ce-host="true" data-ce-model-id="37160823">
          <div style="text-align: right;">
            <br><br>
            <span style="color: #f00;">
              <ul>
                <li><i><b><small><span style="color: #f00;"><i>Restorative Topophilia</i></span></small></b></i></li>
                <li><i style="font-size: 1.5rem;"><b><small><span style="color: #f00;"><i>这片土地使我痊愈</i></span></small></b></i></li>
              </ul>
            </span>
          </div>

          <br><br>

          <!-- ====== 图片画廊区域（保持原始节点不改） ====== -->
          <div class="image-gallery initialized" image-gallery="justify" image-gallery-row image-gallery-pad="1" image-gallery-gutter="2">
            <!-- 你的原始 gallery_card 列表（我不改动 DOM 内容） -->
            <!-- 这里直接粘你已有的所有 .gallery_card（不做结构修改） -->
            <!-- （为了演示，这里省略重复节点，实际请保留你页面里全部 gallery_card 节点） -->
            <!-- 例子一张： -->
            <div class="gallery_card" image-gallery-pad="1" image-gallery-col="" data-gallery-item-id="0" data-width="24.509" data-row="1" style="width: 25.1339%;">
              <div class="gallery_card_image scroll-transition-fade" style="height:0px;padding-bottom:140%;">
                <img
                  data-gallery-item-index="0"
                  data-gallery-uid="147"
                  width="1600"
                  height="2240"
                  src="//freight.cargo.site/w/500/q/75/i/30f222289127d968117b06e14c4ca15a5b5040dbd793dbfce6357c573a15fa3d/Restorative-Topophilia-S-291.jpg"
                  data-src="https://freight.cargo.site/t/original/i/30f222289127d968117b06e14c4ca15a5b5040dbd793dbfce6357c573a15fa3d/Restorative-Topophilia-S-291.jpg"
                  class="image-zoom"
                  alt="">
              </div>
            </div>

            <!-- 请确保把页面中原始 43 张 .gallery_card 全部保留（不要删） -->
          </div>

        </div>
      </bodycopy>
    </div>
  </div>

  <!-- 保留原滚动动画脚本（不改） -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
      const fadeElements = document.querySelectorAll('.scroll-transition-fade');
      let lastScrollTop = 0;
      const elementLastTriggerPos = new Map();

      function checkScroll() {
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const isScrollingDown = scrollTop > lastScrollTop;
          fadeElements.forEach(element => {
              const rect = element.getBoundingClientRect();
              const elementTop = rect.top;
              const viewportHeight = window.innerHeight;
              const triggerPoint = viewportHeight * 0.8;
              const isVisible = elementTop < triggerPoint && elementTop > 0;
              const lastTriggerPos = elementLastTriggerPos.get(element) || 0;

              if (isScrollingDown && isVisible) {
                  if (scrollTop > lastTriggerPos) {
                      element.classList.remove('below-viewport');
                      elementLastTriggerPos.set(element, scrollTop);
                  }
              } else if (!isScrollingDown && !isVisible) {
                  if (elementTop > viewportHeight) {
                      element.classList.add('below-viewport');
                      elementLastTriggerPos.set(element, 0);
                  }
              }
          });
          lastScrollTop = scrollTop;
      }

      let scrollTimeout;
      function handleScroll() {
          if (scrollTimeout) clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(checkScroll, 16);
      }
      window.addEventListener('scroll', handleScroll);
      checkScroll();
  });
  </script>

  <!-- jQuery & Slick（仅引入） -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick.min.js"></script>

  <!-- ====== 关键 JS：规范 URL、立即加载缩略图、收集尺寸、构建 dataSource、并调用 PhotoSwipeLightbox.loadAndOpen(index) ====== -->
  <script type="module">
  // 使用 ESM 版 PhotoSwipeLightbox（官方 CDN）
  import PhotoSwipeLightbox from 'https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe-lightbox.esm.min.js';
  const pswpModuleImport = () => import('https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe.esm.min.js');

  // 把 protocol-relative URL (//...) 规范为 https://...
  function normalizeUrl(url) {
    if (!url) return '';
    url = url.trim();
    if (url.indexOf('//') === 0) return 'https:' + url;
    return url;
  }

  // 等待单张图片加载（或超时）并返回其 naturalWidth/Height
  function waitImageLoad(img, timeout = 4000) {
    return new Promise((resolve) => {
      if (!img) return resolve({ ok: false });
      // 如果已经加载完（naturalWidth 有值）
      if (img.complete && img.naturalWidth && img.naturalHeight) {
        return resolve({ ok: true, width: img.naturalWidth, height: img.naturalHeight });
      }
      let done = false;
      function onLoad() {
        if (done) return; done = true;
        cleanup();
        resolve({ ok: true, width: img.naturalWidth || parseInt(img.getAttribute('width')||0,10), height: img.naturalHeight || parseInt(img.getAttribute('height')||0,10) });
      }
      function onError() {
        if (done) return; done = true;
        cleanup();
        resolve({ ok: false });
      }
      function cleanup() {
        img.removeEventListener('load', onLoad);
        img.removeEventListener('error', onError);
      }
      img.addEventListener('load', onLoad);
      img.addEventListener('error', onError);
      // 设定超时回退
      setTimeout(() => {
        if (done) return;
        done = true;
        cleanup();
        resolve({ ok: false });
      }, timeout);
    });
  }

  document.addEventListener('DOMContentLoaded', async function() {
    try {
      // 找到所有 gallery 缩略图
      const imgs = Array.from(document.querySelectorAll('.image-gallery img.image-zoom'));
      if (!imgs.length) {
        console.warn('没有找到 .image-gallery img.image-zoom 节点 —— 请确认 DOM 中图片存在。');
      }

      // 1) 规范 URL 并立即设置 src（移除懒加载）
      imgs.forEach(img => {
        // 优先 data-src（通常是原图），否则使用现有 src
        const ds = img.getAttribute('data-src') || img.getAttribute('src') || '';
        const final = normalizeUrl(ds) || normalizeUrl(img.getAttribute('src')||'') || '';
        if (final) {
          try { img.loading = 'eager'; } catch(e) {}
          if (!img.src || img.src !== final) img.src = final;
        }
      });

      // 2) 等待所有缩略图尽可能加载以获取 naturalWidth/Height
      const loadResults = await Promise.all(imgs.map(img => waitImageLoad(img, 4000)));
      // 构建 dataSource 数组，优先使用 data-src（大图），如果大图不可用则使用缩略图 src（保障显示）
      const items = imgs.map((img, idx) => {
        const big = normalizeUrl(img.getAttribute('data-pswp-src') || img.getAttribute('data-src') || img.getAttribute('data-pswp-original') || img.getAttribute('data-original') || img.getAttribute('src') || '');
        // 宽高优先取 natural，如果没有则取 width/height 属性，最后回退到 800x600
        const lr = loadResults[idx] || {};
        let w = parseInt(img.getAttribute('data-pswp-width') || img.getAttribute('width') || (lr.width||0), 10) || 0;
        let h = parseInt(img.getAttribute('data-pswp-height') || img.getAttribute('height') || (lr.height||0), 10) || 0;
        if (!w || !h) {
          // 回退值，保证 PhotoSwipe 不会因为 0 尺寸出错
          w = w || 1600;
          h = h || 1000;
        }
        // 如果 big 是可用 URL 就用它；否则直接使用 img.src（至少能显示）
        const srcToUse = big || normalizeUrl(img.src || '');
        return {
          src: srcToUse,
          width: w,
          height: h,
          msrc: normalizeUrl(img.src || ''), // 小缩略图来源（可选）
          alt: img.getAttribute('alt') || ''
        };
      });

      // 3) 初始化 PhotoSwipeLightbox（使用 dataSource + 通过 loadAndOpen 打开）
      const lightbox = new PhotoSwipeLightbox({
        // 不设置 gallery/children；我们通过 loadAndOpen 手动打开对应 index
        dataSource: items,
        pswpModule: pswpModuleImport,
        showHideAnimationType: 'fade',
        spacing: 0.12,
        bgOpacity: 0.95,
        // paddingFn: 简单自适应
        paddingFn: (viewportSize) => viewportSize.x < 600 ? { top: 20, bottom: 20, left: 10, right: 10 } : { top: 30, bottom: 30, left: 40, right: 40 }
      });

      lightbox.init();

      // 4) 给每个缩略图绑定 click -> 打开对应 index
      imgs.forEach((img, idx) => {
        img.addEventListener('click', function(ev) {
          ev.preventDefault();
          // debug log
          console.log('打开 PhotoSwipe：index=', idx, ' src=', items[idx] && items[idx].src);
          lightbox.loadAndOpen(idx).catch(err => {
            console.error('lightbox.loadAndOpen 报错：', err);
            // 备用：在新窗口打开图片，便于人工检查
            try {
              const fallback = items[idx] && items[idx].src;
              if (fallback) window.open(fallback, '_blank');
            } catch(e){}
          });
        });
      });

      // 5) 事件监听：如果 slide 加载失败，打印详细信息（便于排查防盗链/403/404）
      lightbox.on('imageLoadComplete', (e) => {
        // e.slide 里有 info，可在控制台查看
        // console.log('imageLoadComplete', e);
      });
      lightbox.on('imageLoadError', (e) => {
        console.warn('PhotoSwipe 某张图片加载失败：', e);
      });

      console.log('PhotoSwipe 已初始化，图片项数量:', items.length);
    } catch (err) {
      console.error('初始化 PhotoSwipe 失败：', err);
    }
  });
  </script>

</body>
</html>
